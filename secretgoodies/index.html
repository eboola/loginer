<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fortnite-Style 3D Demo</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #000; }
    canvas { display: block; }
    #info {
      position: absolute;
      top: 10px; left: 10px;
      color: white; font-family: sans-serif;
      background: rgba(0,0,0,0.5); padding: 6px 10px; border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="info">WASD = Move, Mouse = Look, Click = Shoot</div>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js';
    import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/controls/PointerLockControls.js';

    // --- Scene setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // --- Lighting ---
    const ambient = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambient);
    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(10, 20, 10);
    sun.castShadow = true;
    sun.shadow.mapSize.set(2048,2048);
    scene.add(sun);

    // --- Ground ---
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x228B22 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // --- Player ---
    const playerGeo = new THREE.CapsuleGeometry(0.5, 1.5, 8, 16);
    const playerMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, metalness: 0.3, roughness: 0.4 });
    const player = new THREE.Mesh(playerGeo, playerMat);
    player.castShadow = true;
    player.position.y = 1.5;
    scene.add(player);

    // --- Controls ---
    const controls = new PointerLockControls(camera, document.body);
    document.body.addEventListener('click', () => controls.lock());
    scene.add(controls.getObject());

    const cameraOffset = new THREE.Vector3(0, 2, -5);
    let velocity = new THREE.Vector3();
    const speed = 0.1;

    // --- Input ---
    const keys = {};
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    // --- Shooting ---
    const bullets = [];
    window.addEventListener('mousedown', shoot);
    function shoot() {
      const bulletGeo = new THREE.SphereGeometry(0.1, 8, 8);
      const bulletMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xdddddd });
      const bullet = new THREE.Mesh(bulletGeo, bulletMat);
      bullet.castShadow = true;
      bullet.position.copy(player.position).add(new THREE.Vector3(0, 1.5, 0));
      const dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      bullet.userData.velocity = dir.multiplyScalar(1.2);
      scene.add(bullet);
      bullets.push(bullet);
    }

    // --- Animate ---
    function animate() {
      requestAnimationFrame(animate);

      const forward = new THREE.Vector3();
      camera.getWorldDirection(forward);
      forward.y = 0; forward.normalize();
      const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward).normalize();

      velocity.set(0,0,0);
      if (keys['KeyW']) velocity.add(forward);
      if (keys['KeyS']) velocity.add(forward.clone().negate());
      if (keys['KeyA']) velocity.add(right.clone().negate());
      if (keys['KeyD']) velocity.add(right);

      velocity.normalize().multiplyScalar(speed);
      player.position.add(velocity);

      // Camera follow
      const playerPos = player.position.clone();
      const camTarget = playerPos.clone().add(cameraOffset.clone());
      camera.position.lerp(camTarget, 0.1);
      camera.lookAt(playerPos.clone().add(new THREE.Vector3(0,1.5,0)));

      // Bullets
      bullets.forEach((b, i) => {
        b.position.add(b.userData.velocity);
        if (b.position.length() > 300) { scene.remove(b); bullets.splice(i,1); }
      });

      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
